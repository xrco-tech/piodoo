<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="chatbot_steps_tree_page" name="Chatbot Steps Page">
        <t t-call="web.layout">
            <t t-set="title">Chatbot Steps - <t t-esc="chatbot.name"/></t>
        
            <div class="o_container mt-4 mb-4">
              <div id="steps-flow-wrap" class="mt-3" t-att-data-csrf="csrf_token or ''" t-att-data-chatbot-id="chatbot_id or 0">
                <div id="steps-flow" class="bb-flow">
                  <!-- SVG must be a child of the scrollable grid so it scrolls with it -->
                  <svg id="bb-lines" class="bb-lines"></svg>
                </div>
                <div id="bb-empty" style="display:none; padding:12px;">No steps to display.</div>
              </div>
            </div>
        
            <t t-jquery="body" t-operation="append">
                <script type="text/javascript">
                  (function () {
                    const wrapEl = document.getElementById('steps-flow-wrap');
                    const csrfToken = wrapEl ? (wrapEl.getAttribute('data-csrf') || '') : '';
                    const chatbotId = wrapEl ? parseInt(wrapEl.getAttribute('data-chatbot-id') || '0', 10) : 0;
                    // Always valid JSON
                    const tree = <t t-raw="tree_json or '[]'"/>;
              
                    // ---- helpers ----
                    function flatten(nodes, level=0, parent=null, out=[]) {
                        (nodes||[]).forEach(n => {
                            out.push({
                            id:n.id, name:n.name, type:n.type, level, parent,
                            children:n.children||[],
                            preview_html:n.preview_html||"",
                            answers:n.answers||[],
                            variables:n.variables||[],
                            });
                            flatten(n.children||[], level+1, n.id, out);
                        });
                        return out;
                    }
                    function maxLevel(a){ return a.reduce((m,n)=>Math.max(m,n.level), 0); }
                    function groupBy(a,k){ const m={}; a.forEach(x=> (m[x[k]] ||= []).push(x)); return m; }
                    function enhanceLinks(root){
                      root.querySelectorAll('a').forEach(a => { a.target = '_blank'; a.rel = 'noopener noreferrer'; });
                    }
                    function openStepModal(stepId) {
                      var w = 920, h = 720;
                      var left = (window.screen.width - w) / 2;
                      var top = (window.screen.height - h) / 2;
                      var url = '/web#model=whatsapp.chatbot.step&amp;view_type=form&amp;id=' + stepId;
                      window.open(url, 'bb-step-form-' + stepId, 'width=' + w + ',height=' + h + ',left=' + left + ',top=' + top + ',menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes');
                    }
                    function openAddStepModal(parentStepId) {
                      var w = 920, h = 720;
                      var left = (window.screen.width - w) / 2;
                      var top = (window.screen.height - h) / 2;
                      var ctx = JSON.stringify({ default_parent_id: parentStepId, default_chatbot_id: chatbotId });
                      var url = '/web#model=whatsapp.chatbot.step&amp;view_type=form&amp;context=' + encodeURIComponent(ctx);
                      window.open(url, 'bb-step-form-new', 'width=' + w + ',height=' + h + ',left=' + left + ',top=' + top + ',menubar=no,toolbar=no,location=no,status=no,resizable=yes,scrollbars=yes');
                    }
              
                    // ---- flow view ----
                    const TYPE_TO_BADGE = {
                      message:'badge-secondary', set_variable:'badge-warning',
                      execute_code:'badge-dark', end_flow:'badge-success'
                    };
                    function renderFlow() {
                        const wrap = document.getElementById('steps-flow-wrap');
                        const grid = document.getElementById('steps-flow');
                        // Ensure SVG exists as first child inside the grid
                        let svg = grid.querySelector('#bb-lines');
                        if (!svg) {
                          svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                          svg.id = 'bb-lines';
                          svg.classList.add('bb-lines');
                          grid.prepend(svg);
                        }
                        const empty = document.getElementById('bb-empty');
                      
                        wrap.style.display = '';
                        // Clear columns but keep (and clear) the SVG
                        svg.innerHTML = '';
                        // Remove any old columns (leave svg intact)
                        grid.querySelectorAll('.bb-col').forEach(c => c.remove());
                      
                        const flat = flatten(tree);
                        if (!flat.length) { empty.style.display = ''; return; }
                        empty.style.display = 'none';
                      
                        const nCols = maxLevel(flat) + 1;
                        const byLevel = groupBy(flat, 'level');
                        grid.style.gridTemplateColumns = `repeat(${nCols}, 320px)`;
                      
                        for (let col = 0; col &lt; nCols; col++) {
                          const column = document.createElement('div');
                          column.className = 'bb-col';
                          (byLevel[col] || []).forEach(node => {
                            const card = document.createElement('div');
                            card.className = 'bb-card';
                            card.dataset.id = node.id;
                            if (node.parent) card.dataset.parent = node.parent;
                      
                            const title = document.createElement('div');
                            title.className = 'bb-title';
                            title.textContent = node.name || ('Step #'+node.id);
                            card.appendChild(title);

                            if ((node.answers &amp;&amp; node.answers.length) || (node.variables &amp;&amp; node.variables.length)) {
                                const tags = document.createElement('div');
                                tags.className = 'bb-tags';

                                const addTag = (text, cls) => {
                                    const t = document.createElement('span');
                                    t.className = 'bb-tag ' + cls;
                                    t.textContent = text;              // safe (no HTML)
                                    tags.appendChild(t);
                                };

                                (node.answers || []).forEach(txt => addTag(txt, 'bb-tag-answer'));
                                (node.variables || []).forEach(txt => addTag(txt, 'bb-tag-variable'));

                                card.appendChild(tags);
                            }
                      
                            if (node.preview_html) {
                                const wrap = document.createElement('div');
                                wrap.className = 'bb-preview';
                              
                                wrap.innerHTML = `
                                  <div class="o_whatsapp_preview overflow-hidden ps-3 pe-5">
                                    <div class="o_whatsapp_message mt-2 mb-1 fs-6 lh-1 float-start text-break text-black position-relative">
                                      <div class="o_whatsapp_message_core p-2 position-relative" style="background-color:#ffffff;">
                                        <div class="o_whatsapp_message_body px-1 mt-2" style="white-space: normal; word-wrap: break-word;">
                                          ${node.preview_html}
                                        </div>
                                        <span class="position-absolute bottom-0 end-0 o-whatsapp-font-11 py-1 px-2 text-black-50"></span>
                                      </div>
                                      <div class="o_whatsapp_message_links cursor-default px-0"></div>
                                    </div>
                                  </div>`;
                                enhanceLinks(wrap);
                                card.appendChild(wrap);
                              }

                            const chipRow = document.createElement('div');
                            chipRow.className = 'bb-chip-row';
                            if (node.type) {
                              const chip = document.createElement('span');
                              chip.className = 'bb-chip ' + (TYPE_TO_BADGE[node.type] || 'badge-light');
                              chip.textContent = node.type.replace(/_/g,' ');
                              chipRow.appendChild(chip);
                            }
                            const actions = document.createElement('div');
                            actions.className = 'bb-actions';
                            const open = document.createElement('a');
                            open.href = '/web#model=whatsapp.chatbot.step&amp;view_type=form&amp;id='+node.id;
                            open.className = 'bb-open';
                            open.textContent = 'Open';
                            open.onclick = function(e) {
                              e.preventDefault();
                              openStepModal(node.id);
                              return false;
                            };
                            actions.appendChild(open);
                            const delBtn = document.createElement('button');
                            delBtn.type = 'button';
                            delBtn.className = 'bb-delete';
                            delBtn.textContent = 'Delete';
                            delBtn.dataset.stepId = node.id;
                            delBtn.onclick = function() {
                              if (!confirm('Delete this step? This cannot be undone.')) return;
                              const stepId = this.dataset.stepId;
                              const body = new URLSearchParams({ csrf_token: csrfToken });
                              fetch('/chatbot/step/' + stepId + '/delete', {
                                method: 'POST',
                                headers: {
                                  'Content-Type': 'application/x-www-form-urlencoded',
                                  'X-CSRF-TOKEN': csrfToken,
                                },
                                body: body.toString(),
                              }).then(function(r) {
                                return r.text().then(function(text) {
                                  var data = {};
                                  try { data = JSON.parse(text); } catch (e) {}
                                  if (r.ok &amp;&amp; data.success) {
                                    window.location.href = '/chatbot/steps/' + chatbotId;
                                  } else {
                                    alert(data.error || 'Could not delete step.');
                                  }
                                });
                              }).catch(function() {
                                alert('Request failed. Please try again.');
                              });
                            };
                            actions.appendChild(delBtn);
                            chipRow.appendChild(actions);
                            card.appendChild(chipRow);

                            const addBtn = document.createElement('button');
                            addBtn.type = 'button';
                            addBtn.className = 'bb-add-step';
                            addBtn.title = 'Add child step';
                            addBtn.textContent = '+';
                            addBtn.dataset.parentId = node.id;
                            addBtn.onclick = function(e) {
                              e.preventDefault();
                              e.stopPropagation();
                              openAddStepModal(parseInt(this.dataset.parentId, 10));
                            };
                            card.appendChild(addBtn);
                      
                            column.appendChild(card);
                          });
                          grid.appendChild(column);
                        }
                      
                        function drawLines() {
                          // Size SVG to the entire scrollable grid
                          const w = grid.scrollWidth;
                          const h = grid.scrollHeight;
                          svg.setAttribute('width', w);
                          svg.setAttribute('height', h);
                          svg.style.width  = w + 'px';
                          svg.style.height = h + 'px';
                          svg.innerHTML = '';
                      
                          // Create marker definitions for arrow (dot replaced by "+" button on card)
                          const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                          
                          // Arrow marker at end
                          const arrowMarker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                          arrowMarker.setAttribute('id', 'arrow-marker');
                          arrowMarker.setAttribute('markerWidth', '8');
                          arrowMarker.setAttribute('markerHeight', '8');
                          arrowMarker.setAttribute('refX', '0');
                          arrowMarker.setAttribute('refY', '4');
                          arrowMarker.setAttribute('orient', 'auto');
                          arrowMarker.setAttribute('markerUnits', 'strokeWidth');
                          const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                          arrowPath.setAttribute('d', 'M0,0 L0,8 L6,4 z');
                          arrowPath.setAttribute('fill', '#374151');
                          arrowPath.setAttribute('stroke', '#ffffff');
                          arrowPath.setAttribute('stroke-width', '1');
                          arrowMarker.appendChild(arrowPath);
                          defs.appendChild(arrowMarker);
                          
                          svg.appendChild(defs);
                      
                          const gr = grid.getBoundingClientRect();
                      
                          const byId = {};
                          grid.querySelectorAll('.bb-card').forEach(c => byId[c.dataset.id] = c);
                      
                          grid.querySelectorAll('.bb-card').forEach(child => {
                            const pid = child.dataset.parent; if (!pid) return;
                            const parent = byId[pid]; if (!parent) return;
                      
                            const pr = parent.getBoundingClientRect();
                            const cr = child.getBoundingClientRect();
                            // +14px so line starts at right edge of .bb-add-step (right: -14px places circle 14px past card)
                            const addBtnOffset = 14;
                            // Coordinates relative to grid's top-left
                            const x1 = pr.right - gr.left + addBtnOffset;
                            const y1 = pr.top + pr.height / 2 - gr.top;
                            const x2 = cr.left - gr.left;  // Arrow will touch the left edge
                            const y2 = cr.top + cr.height / 2 - gr.top;
                            const mx = (x1 + x2) / 2;
                      
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            path.setAttribute('d', `M ${x1} ${y1} C ${mx} ${y1}, ${mx} ${y2}, ${x2} ${y2}`);
                            path.setAttribute('class', 'bb-connector');
                            path.setAttribute('marker-end', 'url(#arrow-marker)');
                            svg.appendChild(path);
                          });
                        }
                      
                        drawLines();
                        setTimeout(drawLines, 50);
                        window.addEventListener('resize', drawLines, { passive: true });

                        // Enable click-and-drag panning on the scrollable wrapper
                        enableDragScroll(wrap);
                      }

                      function enableDragScroll(el) {
                        let isDragging = false;
                        let startX = 0;
                        let startY = 0;
                        let startScrollLeft = 0;
                        let startScrollTop = 0;

                        el.addEventListener('mousedown', (e) => {
                          if (e.button !== 0) return; // only left click
                          isDragging = true;
                          el.classList.add('bb-dragging');
                          startX = e.clientX;
                          startY = e.clientY;
                          startScrollLeft = el.scrollLeft;
                          startScrollTop = el.scrollTop;
                          e.preventDefault();
                        });

                        window.addEventListener('mousemove', (e) => {
                          if (!isDragging) return;
                          const dx = e.clientX - startX;
                          const dy = e.clientY - startY;
                          el.scrollLeft = startScrollLeft - dx;
                          el.scrollTop = startScrollTop - dy;
                        }, { passive: true });

                        window.addEventListener('mouseup', () => {
                          if (!isDragging) return;
                          isDragging = false;
                          el.classList.remove('bb-dragging');
                        });

                        // Touch support
                        el.addEventListener('touchstart', (e) => {
                          const t = e.touches &amp;&amp; e.touches[0];
                          if (!t) return;
                          isDragging = true;
                          el.classList.add('bb-dragging');
                          startX = t.clientX;
                          startY = t.clientY;
                          startScrollLeft = el.scrollLeft;
                          startScrollTop = el.scrollTop;
                        }, { passive: true });

                        el.addEventListener('touchmove', (e) => {
                          if (!isDragging) return;
                          const t = e.touches &amp;&amp; e.touches[0];
                          if (!t) return;
                          const dx = t.clientX - startX;
                          const dy = t.clientY - startY;
                          el.scrollLeft = startScrollLeft - dx;
                          el.scrollTop = startScrollTop - dy;
                        }, { passive: true });

                        el.addEventListener('touchend', () => {
                          isDragging = false;
                          el.classList.remove('bb-dragging');
                        });
                      }
              
                    // Init
                    renderFlow();
                  })();
            </script>
            </t>
        
            <t t-jquery="head" t-operation="append">
              <style>
                #steps-flow-wrap{position:relative;overflow:auto;min-height:200px;max-height:calc(100vh - 180px);cursor:grab}
                #steps-flow-wrap.bb-dragging{cursor:grabbing}
                .bb-flow{display:grid;align-items:start;gap:48px;position:relative;padding:8px 8px 32px 8px;min-width:min-content;width:max-content}
                .bb-col{display:flex;flex-direction:column;gap:16px}
                .bb-card{width:300px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:10px 12px 12px}
                .bb-title{font-weight:600;margin-bottom:6px}
                .bb-chip{display:inline-block;font-size:12px;line-height:1;border-radius:999px;padding:4px 8px;margin-right:6px;margin-top:6px}
                .bb-chip-row{display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin-top:6px}
                .bb-chip-row .bb-chip{margin-right:0;margin-top:0}
                .bb-actions{display:inline-flex;align-items:center;gap:8px;line-height:1;font-size:12px;min-height:20px}
                .bb-open{display:inline-flex;align-items:center;font-size:12px;line-height:1;color:#0b56d0;text-decoration:none}
                .bb-open:hover{text-decoration:underline}
                .bb-delete{font-size:12px;line-height:1;color:#dc3545;text-decoration:none;cursor:pointer;border:none;background:none;padding:0;display:inline-flex;align-items:center}
                .bb-delete:hover{text-decoration:underline;color:#bb2d3b}
                .badge-secondary{background:#e9ecef}.badge-info{background:#cff4fc}.badge-warning{background:#fff3cd}.badge-dark{background:#ced4da}.badge-success{background:#d1e7dd}.badge-light{background:#f8f9fa}
                .bb-lines{position:absolute;left:0;top:0;pointer-events:none;width:100%;height:100%;z-index:10}
                .bb-connector{fill:none;stroke:#c0c4cc;stroke-width:2}
                .bb-preview {
                margin-top:6px; font-size:12px; line-height:1.35;
                color:#374151;  border:1px solid #e5e7eb;
                border-radius:8px; padding:8px; word-break:break-word;
                }
                .bb-preview-html p { margin: 0 0 6px 0; }
                .bb-preview-html ul { margin: 0 0 6px 16px; padding: 0; }
                .bb-preview-html li { margin: 0 0 4px 0; }
                .bb-flow { position: relative; }
                .bb-lines {
                position: absolute;
                left: 0;
                top: 0;
                pointer-events: none;
                z-index:10;
                }
                .bb-card { position: relative; z-index: 1; }
                .bb-add-step {
                  position: absolute;
                  right: -14px;
                  top: 50%;
                  transform: translateY(-50%);
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  border: 1px solid #e5e7eb;
                  background: #fff;
                  color: #374151;
                  font-size: 16px;
                  line-height: 1;
                  padding: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  box-shadow: 0 1px 2px rgba(0,0,0,.08);
                  z-index: 20;
                }
                .bb-add-step:hover {
                  background: #0b56d0;
                  color: #fff;
                  border-color: #0b56d0;
                }
                .bb-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 6px;
                }
                .bb-tag {
                display: inline-block;
                font-size: 11px;
                line-height: 1;
                padding: 4px 8px;
                border-radius: 999px;
                border: 1px solid #e5e7eb;
                background: #f3f4f6;
                color: #374151;
                max-width: 100%;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                }
                .bb-tag-answer {
                background: #e7f0ff;
                border-color: #cfe0ff;
                color: #0b56d0;
                }
                .bb-tag-variable {
                background: #eafbf0;
                border-color: #cfead9;
                color: #176b3a;
                }
                .bb-preview { margin-top: 6px; }
                
                .o_whatsapp_preview { max-width: 100%;}
                .o_whatsapp_message {
                  background: transparent;
                  max-width: 100%;
                }
                .o_whatsapp_message_core {
                    background: transparent;
                }
                .o_whatsapp_message_body {
                  color: #111827; /* near-black text */
                  font-size: 14px; /* akin to fs-6 */
                  line-height: 1.35;
                  word-break: break-word;
                }
                .o_whatsapp_message_body p { margin: 0 0 6px 0; }
                .o_whatsapp_message_body ul { margin: 0 0 6px 1.25rem; padding: 0; }
                .o_whatsapp_message_body li { margin: 0 0 4px 0; }
                .o-whatsapp-font-11 { font-size: 11px; }
                
                .o_whatsapp_message_links hr {
                  border: 0; height: 1px; background: #e5e7eb; opacity: 1;
                }
                .o_whatsapp_message_link {
                  font-size: 13px;
                  color: #0b56d0;
                  user-select: none;
                }
                .bb-card .o_whatsapp_preview { max-width: 100%; }
                .bb-card .o_whatsapp_message_core { overflow: hidden; }
                
                .bb-card, .bb-card * {
                font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                }
              </style>
            </t>
          </t>
    </template>
</odoo>
